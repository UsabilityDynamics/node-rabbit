<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/rabbit.js - Rabbit</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://a3d72a45d111006ec192-ec5b80a12b0b09b4d52373336afb4254.r80.cf1.rackcdn.com/usability-dynamics.png" title="Rabbit"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/rabbit.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Rabbit
 *
 * The Rabbit works, or else the Rabbit gets fucked; proper fucked, that is
 *
 * ## Events
 * - connection: General connection event - could be an error or a success.
 * - connection.success: Successful connection event.
 * - connection.error: Connection failure.
 *
 * @param settings {Object} Configuration.
 * @param settings.api {String} URL to RabbitMQ management API, if available.
 * @param cb {Function} Callback function.
 * @returns {Rabbit}
 * @constructor
 */
function Rabbit( settings, cb ) {
  Rabbit.debug( &#x27;Creating new connection.&#x27; );

  // Make sure context is correct otherwise we could screw up the global scope.
  if( !( this instanceof Rabbit ) ) {
    return new Rabbit( settings, cb );
  }

  var Instance = this;

  // Mixin Settings and EventEmitter
  require( &#x27;object-settings&#x27; ).mixin( Instance );
  require( &#x27;object-emitter&#x27; ).mixin( Instance );

  // Configure instance.
  Instance.set({
    settings: Rabbit.extend( {}, Rabbit.defaults, settings ),
    exchange: {},
    identity: String( process.pid )
  });

  // Connect to AMQP.
  this.connection = Rabbit.amqp.createConnection({
    host: Instance.get( &#x27;settings.host&#x27; ),
    port: Instance.get( &#x27;settings.port&#x27; ),
    login: Instance.get( &#x27;settings.login&#x27; ),
    password: Instance.get( &#x27;settings.password&#x27; ),
    vhost: Instance.get( &#x27;settings.vhost&#x27; )
  }, {
    defaultExchangeName: Instance.get( &#x27;settings.defaultExchange&#x27;, &#x27;&#x27; ),
    reconnect: Instance.get( &#x27;settings.reconnect&#x27;, true ),
  });

  // Bind callback to ready event, if provided.
  if( &#x27;function&#x27; === typeof cb ) {
    this.on( &#x27;ready&#x27;, cb );
  }

  // RabbitMQ connection failed.
  this.connection.on( &#x27;error&#x27;, function rabbit_error( error ) {
    Instance.emit( &#x27;connection&#x27;, new Error( error.message ), Instance );
    Instance.emit( &#x27;connection.error&#x27;, new Error( error.message ), Instance );
  });

  // RabbitMQ connection established.
  this.connection.on( &#x27;ready&#x27;, function rabbit_ready( connection ) {

    this.exchange( &#x27;wabbit&#x27;, {
      type: &#x27;topic&#x27;,
      passive: false,
      durable: true,
      //confirm: true,
      //autoDelete: true,
      //noDeclare: false,
    }, function have_exchange() {

      // Set Exchange Variables.
      Instance.set( &#x27;exchange&#x27;, this );

      // Emit connection success.
      Instance.emit( &#x27;connection&#x27;, null, Instance );
      Instance.emit( &#x27;connection.success&#x27;, Instance );

    });

  });

  // Return context.
  return this;

}

// Rabbit prototype properties.
Object.defineProperties( Rabbit.prototype, {
  api: {
    /**
     * Make RabbitMQ API Request
     *
     * @example
     *
     *    // Get Vhosts
     *    Instance.api( &#x27;get&#x27;, &#x27;vhosts&#x27;, console.log );
     *
     *    // Get queues
     *    Instance.api( &#x27;get&#x27;, &#x27;queues&#x27;, console.log );
     *
     * @async
     * @chainable
     * @param method
     * @param query
     * @param cb
     */
    value: function api( method, query, cb ) {

      Rabbit.request({
        url: Instance.get( &#x27;settings.api&#x27; ) + &#x27;/vhosts&#x27;,
        json: true,
        auth: {
          user: Instance.get( &#x27;settings.login&#x27; ),
          pass: Instance.get( &#x27;settings.password&#x27; )
        }
      }, function( error, req, body ) { cb( error, body ); });

      // Chainable.
      return this;

    },
    enumerable: true,
    writable: true,
    configurable: true
  },
  defineJob: {
    /**
     * Define a job.
     *
     * @param name {String} Name of job type.
     * @param fn {Function} Function to process job.
     */
    value: function defineJob( name, fn ) {

      var Instance = this;

      // Job Queue Options.
      var _options = {
        durable: true,
        autoDelete: false,
        passive: false,
        arguments: {
          name: name
        }
      };

      // Use the default &#x27;amqueue.topic&#x27; exchange
      this.connection.queue( _options.arguments.name, _options, function have_queue( queue ) {
        console.log( &#x27;have_queue&#x27;, queue.state, Instance.get( &#x27;exchange.name&#x27; ) );

        // Bind to exchange with routing of &quot;job&quot;
        queue.bind( Instance.get( &#x27;exchange.name&#x27; ), name );

        // Receive messages
        queue.subscribe({ prefetchCount: 1, ack: true }, function have_message( message, headers, info ) {

          console.log( &#x27;message&#x27;, message );
          console.log( &#x27;headers&#x27;, headers );
          // console.log( &#x27;deliveryTag&#x27;, info.deliveryTag.toString() );

          setTimeout( function() {
            queue.shift();
          }, 1000 )

        });

      });

    },
    enumerable: true,
    writable: true,
    configurable: true
  },
  runJob: {
    /**
     * Run a job.
     *
     * @param name
     * @param data
     * @param response
     */
    value: function runJob( name, data, response ) {

      var _options = {
        type: &#x27;job&#x27;,
        correlationId : Math.random().toString( 36 ).substring( 2 ),
        contentType:&#x27;application/json&#x27;,
        headers: {
          format: &#x27;json&#x27;,
          sid: Math.random().toString( 36 ).substring( 2 ),
          jid: Math.random().toString( 36 ).substring( 2 ),
          pid: this.get( &#x27;identity&#x27; )
        },
        deliveryMode: 2
        // immediate : false,
        // confirm: false,
        // priority: 9,
        // expiration: &quot;10000&quot;,
        // messageId: Math.random().toString( 36 ).substring( 2 ),
        // replyTo: message.email,
        // appId: this.get( &#x27;app_id&#x27; )
      }

      this.get( &#x27;exchange&#x27; ).publish( name, data, _options, function published() {
        console.log( &#x27;job request published&#x27; );

        // Instance.subscribe( _options.correlationId );

      });

      return this;

    },
    enumerable: true,
    writable: true,
    configurable: true
  },
  define: {
    get: function() { return this.defineJob },
    enumerable: false,
    configurable: true
  },
  run: {
    get: function() { return this.runJob },
    enumerable: false,
    configurable: true
  },
  message: {
    value: require( &#x27;./message&#x27; ),
    enumerable: true,
    writable: true,
    configurable: true
  }
});

// Rabit constructor properties.
Object.defineProperties( module.exports = Rabbit, {
  debug: {
    value: require( &#x27;debug&#x27; )( &#x27;rabbit&#x27; ),
    enumerable: false,
    writable: true,
    configurable: true
  },
  request: {
    value: require( &#x27;request&#x27; ),
    enumerable: false,
    writable: true,
    configurable: true
  },
  extend: {
    value: require( &#x27;extend&#x27; ),
    enumerable: false,
    writable: true,
    configurable: true
  },
  amqp: {
    value: require( &#x27;amqp&#x27; ),
    enumerable: false,
    writable: true,
    configurable: true
  },
  defaults: {
    value: {
      host: &#x27;localhost&#x27;,
      port: 5672,
      login: &#x27;guest&#x27;,
      password: &#x27;guest&#x27;,
      vhost: &#x27;/&#x27;,
      exchange: &#x27;wabbit&#x27;,
      reconnect: true,
      api: &#x27;http://localhost:15672/api&#x27;
    },
    enumerable: false,
    writable: true,
    configurable: true
  },
  createConnection: {
    /**
     * Returns new instance of Rabbit.
     *
     * @param settings {Object} Configuration for connection.
     * @returns {Rabbit}
     */
    value: function createConnection ( settings, cb ) {
      return new Rabbit( settings, cb );
    },
    enumerable: true,
    writable: true,
    configurable: true
  }
});





    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
